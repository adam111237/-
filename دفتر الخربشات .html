<!DOCTYPE html>
<html lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ø®Ø±Ø¨ÙˆØ´ - Ù…ØºØ§Ù…Ø±Ø© Ø§Ù„Ø¯ÙØªØ± Ø§Ù„Ø­Ø²ÙŠÙ†Ø©</title>
    <style>
        :root { --ink: #1a1a1a; --paper: #f4f1ea; --line: #d1d1d1; --margin-line: #ff8585; }
        body { margin: 0; overflow: hidden; background: #222; font-family: 'Courier New', monospace; touch-action: none; user-select: none; direction: rtl; }
        
        .notebook-bg { 
            position: fixed; inset: 0; background-color: var(--paper);
            background-image: linear-gradient(var(--line) 1px, transparent 1px), linear-gradient(90deg, transparent 79px, var(--margin-line) 2px, transparent 81px);
            background-size: 100% 30px, 100% 100%; z-index: -1;
        }

        .doodle { position: absolute; opacity: 0.15; pointer-events: none; z-index: 0; transform: rotate(-5deg); font-weight: bold; color: var(--ink); }
        canvas { display: block; z-index: 1; position: relative; }
        
        .screen { position: fixed; inset: 0; display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 1000; text-align: center; padding: 20px; transition: 0.3s; }
        .hidden { display: none !important; opacity: 0; }
        
        h1 { font-size: 3.5rem; color: var(--ink); margin-bottom: 5px; transform: rotate(-2deg); text-shadow: 3px 3px 0px var(--line); position: relative; }
        .sub-warning { font-size: 0.9rem; color: var(--ink); opacity: 0.7; margin-bottom: 30px; font-weight: bold; }

        .menu-btn { 
            width: 240px; padding: 18px; margin: 12px; border: 4px solid var(--ink); 
            background: white; color: var(--ink); font-size: 1.4rem; font-weight: 900; 
            cursor: pointer; box-shadow: 7px 7px 0 var(--ink); border-radius: 2px 15px 5px 10px;
        }
        .menu-btn:active { transform: translate(4px, 4px); box-shadow: 2px 2px 0 var(--ink); }

        .story-container { 
            max-width: 550px; background: white; border: 4px solid var(--ink); 
            padding: 30px; box-shadow: 12px 12px 0 var(--margin-line);
            border-radius: 5px 30px 5px 25px; position: relative;
        }
        .story-text { font-size: 1.5rem; line-height: 1.7; color: var(--ink); margin-bottom: 30px; text-align: right; min-height: 120px; font-weight: bold; }

        #hud { position: absolute; top: 15px; width: 100%; display: flex; justify-content: space-around; pointer-events: none; z-index: 100; display: none; }
        .stat-box { background: white; padding: 8px 20px; border: 3px solid var(--ink); font-weight: 900; box-shadow: 4px 4px 0 var(--line); }
        .ink-bar { width: 120px; height: 15px; background: #ddd; border: 2px solid var(--ink); display: inline-block; }
        #ink-fill { width: 100%; height: 100%; background: var(--ink); }

        .controls { position: absolute; bottom: 35px; width: 100%; display: flex; justify-content: space-between; padding: 0 40px; box-sizing: border-box; display: none; z-index: 100; }
        .btn { width: 85px; height: 85px; background: rgba(255,255,255,0.95); border: 4px solid var(--ink); border-radius: 18px; font-size: 40px; display: flex; align-items: center; justify-content: center; box-shadow: 0 8px 0 var(--ink); }
        .btn-action { background: var(--ink) !important; color: white !important; border-radius: 50%; width: 95px; height: 95px; }
    </style>
</head>
<body>

    <div class="notebook-bg">
        <div class="doodle" style="top:10%; left:10%; font-size: 5rem;">?</div>
        <div class="doodle" style="bottom:15%; right:10%; font-size: 4rem;">X_X</div>
        <div class="doodle" style="top:50%; left:5%; font-size: 3rem;">HELP</div>
        <div class="doodle" style="top:20%; right:20%; font-size: 2rem;">âœ...</div>
        <div class="doodle" style="bottom:30%; left:20%; font-size: 2rem; transform: rotate(15deg);">Ù…ÙØ³ÙˆØ¯Ø©</div>
    </div>

    <div id="loading-screen" class="screen">
        <h1 style="font-size: 2rem;">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…ØºØ§Ù…Ø±Ø©</h1>
        <div style="width: 250px; height: 25px; border: 4px solid var(--ink); background: white;">
            <div id="load-progress" style="width: 0%; height: 100%; background: var(--ink);"></div>
        </div>
    </div>

    <div id="main-menu" class="screen hidden">
        <h1>Ø¯ÙØªØ± Ø§Ù„Ø®Ø±Ø§Ø¨ÙŠØ´</h1>
        <div class="sub-warning">(ÙƒÙ„ Ø§Ù„Ø±Ø³ÙˆÙ…Ø§Øª Ù…Ù‡Ø¯Ø¯Ø© Ø¨Ù„ Ù…Ø³Ø­)</div>
        <button class="menu-btn" onclick="checkStoryAndStart()">Ø§Ø¨Ø¯Ø£ Ø§Ù„Ø±Ø­Ù„Ø© âœ</button>
        <button class="menu-btn" onclick="openSettings()">Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</button>
    </div>

    <div id="story-screen" class="screen hidden">
        <div class="story-container">
            <h2 style="margin-top:0; color:var(--margin-line); border-bottom: 2px dashed var(--ink);">Ù…Ø°ÙƒØ±Ø© Ø§Ù„Ø·ÙÙ„</h2>
            <div id="story-display" class="story-text"></div>
            <div style="display:flex; gap:15px; justify-content:center;">
                <button class="menu-btn" style="width: 120px;" onclick="nextPage()">Ø§Ù„ØªØ§Ù„ÙŠ</button>
                <button class="menu-btn" style="width: 120px; background:#f0f0f0;" onclick="skipStory()">ØªØ®Ø·ÙŠ</button>
            </div>
        </div>
    </div>

    <div id="level-select" class="screen hidden">
        <h1>Ø§Ù„ØµÙØ­Ø§Øª Ø§Ù„Ù…ØªØ§Ø­Ø©</h1>
        <div id="levels-grid" style="display:grid; grid-template-columns: repeat(5,1fr); gap:15px; direction:ltr; margin-bottom:30px;"></div>
        <button class="menu-btn" onclick="backToMenu()">Ø±Ø¬ÙˆØ¹</button>
    </div>

    <div id="settings-screen" class="screen hidden">
        <h1>Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</h1>
        <button class="menu-btn" onclick="toggleMusic()" id="music-btn">Ø§Ù„Ù…ÙˆØ³ÙŠÙ‚Ù‰: ON</button>
        <button class="menu-btn" onclick="resetGame()" style="color:red; border-color: red;">Ù…Ø³Ø­ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
        <button class="menu-btn" onclick="backToMenu()">Ø±Ø¬ÙˆØ¹</button>
    </div>

    <div id="hud">
        <div class="stat-box" id="lvl-tag">Ø§Ù„ØµÙØ­Ø© 1</div>
        <div class="stat-box">Ø­Ø¨Ø±: <div class="ink-bar"><div id="ink-fill"></div></div></div>
    </div>

    <div class="controls" id="game-controls">
        <div class="btn-side">
            <div class="btn" id="btn-right">â†’</div>
            <div class="btn btn-action" id="btn-draw" style="margin-right: 15px;">âœ</div>
        </div>
        <div class="btn-side">
            <div class="btn btn-action" id="btn-jump" style="margin-left: 15px;">â†‘</div>
            <div class="btn" id="btn-left">â†</div>
        </div>
    </div>

    <canvas id="game"></canvas>

<script>
const canvas = document.getElementById('game');
const ctx = canvas.getContext('2d');
let isPlaying = false;
let unlockedLevels = parseInt(localStorage.getItem('sketchLvl')) || 1;
let storySeen = localStorage.getItem('storySeen') === 'true';
let musicEnabled = true;

const storyData = [
    "ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ Ø·ÙÙ„ Ù…Ø´Ø§ØºØ¨ Ø¬Ø¯Ø§Ù‹.. ÙƒÙ„Ù…Ø§ Ø®Ø·Ø±Øª ÙÙŠ Ø°Ù‡Ù†Ù‡ ÙÙƒØ±Ø©ØŒ Ø±Ø³Ù…Ù‡Ø§ Ø¨Ø¹Ù†Ù ÙÙŠ Ø¯ÙØªØ±Ù‡ Ø§Ù„ØµØºÙŠØ±.",
    "ÙƒØ§Ù†Øª Ø±Ø³ÙˆÙ…Ø§ØªÙ‡ Ù…Ù„ÙŠØ¦Ø© Ø¨Ø§Ù„Ø®Ø±Ø§Ø¨ÙŠØ´ Ø§Ù„Ù…ØªØ´Ø§Ø¨ÙƒØ© ÙˆØ§Ù„Ø­Ø¨Ø± Ø§Ù„Ù…ØªØ·Ø§ÙŠØ±.",
    "ÙÙŠ Ø²Ø§ÙˆÙŠØ© Ù…Ù†Ø³ÙŠØ©ØŒ Ø±Ø³Ù… 'Ø®Ø±Ø¨ÙˆØ´'.. ÙƒØ§Ù† Ù…Ø¬Ø±Ø¯ Ù…Ø±Ø¨Ø¹ Ø¨Ø³ÙŠØ·ØŒ Ø§Ù„Ø£Ù‚Ù„ Ø®Ø±Ø§Ø¨ÙŠØ´Ø§Ù‹ Ø¨ÙŠÙ†Ù‡Ù… Ø¬Ù…ÙŠØ¹Ø§Ù‹.",
    "Ø´Ø¹Ø± 'Ø®Ø±Ø¨ÙˆØ´' Ø¨Ø§Ù„ÙˆØ­Ø¯Ø©ØŒ ÙÙ‚Ø±Ø± Ø§Ù„Ù‡Ø±ÙˆØ¨ Ù…Ù† Ø§Ù„Ø¯ÙØªØ± ÙˆØ§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø¹Ø§Ù„Ù… Ø­Ù‚ÙŠÙ‚ÙŠ Ø¨Ù…Ø³Ø§Ø¹Ø¯Ø© Ù…Ø§ ØªØ¨Ù‚Ù‰ Ù…Ù† Ø­Ø¨Ø±."
];
let storyPointer = 0;

// ØµÙˆØª
const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
let musicInterval;
function playSfx(f, type, d, v) {
    if(!musicEnabled) return;
    try {
        const o = audioCtx.createOscillator(); const g = audioCtx.createGain();
        o.type = type; o.frequency.setValueAtTime(f, audioCtx.currentTime);
        g.gain.setValueAtTime(v, audioCtx.currentTime);
        g.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + d);
        o.connect(g); g.connect(audioCtx.destination);
        o.start(); o.stop(audioCtx.currentTime + d);
    } catch(e){}
}
function startMusic() {
    if (musicInterval) clearInterval(musicInterval);
    let step = 0;
    const notes = [110, 146, 164, 110, 196, 110, 164, 130];
    musicInterval = setInterval(() => {
        if (!isPlaying || !musicEnabled) return;
        playSfx(notes[step % notes.length], 'square', 0.2, 0.03);
        if (step % 4 === 0) playSfx(60, 'sine', 0.2, 0.1);
        step++;
    }, 160);
}

// ØªÙ†Ù‚Ù„
function hideAll() { document.querySelectorAll('.screen').forEach(s => s.classList.add('hidden')); }
function checkStoryAndStart() {
    // Ø¯Ø§Ø¦Ù…Ø§Ù‹ Ù†Ø¨Ø¯Ø£ Ø¨Ø§Ù„Ù‚ØµØ© Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ "Ø§Ø¨Ø¯Ø£" Ø¥Ø°Ø§ Ù„Ù… ØªÙØ´Ø§Ù‡Ø¯ Ø¨Ø¹Ø¯ Ø£Ùˆ Ø¹Ù†Ø¯ Ø¯Ø®ÙˆÙ„ Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰
    if(storySeen) { 
        hideAll(); 
        document.getElementById('level-select').classList.remove('hidden'); 
        updateLevelGrid(); 
    } else {
        startStorySequence();
    }
}

function startStorySequence() {
    storyPointer = 0; 
    hideAll(); 
    document.getElementById('story-screen').classList.remove('hidden'); 
    renderStory();
}

function renderStory() { document.getElementById('story-display').innerText = storyData[storyPointer]; }
function nextPage() { storyPointer++; if(storyPointer < storyData.length) renderStory(); else skipStory(); }
function skipStory() { 
    storySeen = true; 
    localStorage.setItem('storySeen', 'true'); 
    startLevel(0); 
}

function openSettings() { hideAll(); document.getElementById('settings-screen').classList.remove('hidden'); }
function backToMenu() { hideAll(); document.getElementById('main-menu').classList.remove('hidden'); }
function updateLevelGrid() {
    const grid = document.getElementById('levels-grid'); grid.innerHTML = '';
    for(let i=1; i<=10; i++) {
        const b = document.createElement('button'); b.className = 'menu-btn'; b.style.width = '65px'; b.innerText = i;
        if(i > unlockedLevels) b.style.opacity = '0.3';
        b.onclick = () => { 
            if(i <= unlockedLevels) {
                if(i === 1 && !localStorage.getItem('storySeen')) {
                    startStorySequence();
                } else {
                    startLevel(i-1); 
                }
            }
        };
        grid.appendChild(b);
    }
}

// Ù…Ø­Ø±Ùƒ Ø§Ù„Ù„Ø¹Ø¨Ø©
const stages = [];
for(let i=0; i<10; i++) {
    let p = [{x:0, y:500, w:300, h:40}];
    for(let j=1; j<20; j++) p.push({x:j*450+Math.random()*150, y:250+Math.random()*300, w:180+Math.random()*100, h:30});
    p[p.length-1].goal = true;
    stages.push(p);
}

// Ø§Ù„Ø´Ø®ØµÙŠØ© (Ø§Ù„Ø¬Ø³Ù… Ø£Ø¨ÙŠØ¶ Ø§Ù„Ø¢Ù†)
let player = { 
    x:50, y:0, vx:0, vy:0, w:40, h:40, ink:100, grounded:false, dir:1,
    eyeBlink: 0,
    animTimer: 0,
    squash: 1, stretch: 1
};

let currentLvlIdx = 0, inkPaths = [], currentPath = null, cam = {x:0, y:0};
let inputs = { left:false, right:false, jump:false, draw:false };

function startLevel(idx) {
    currentLvlIdx = idx; inkPaths = []; isPlaying = true;
    player.x = 50; player.y = 400; player.vx = 0; player.vy = 0; player.ink = 100;
    hideAll();
    document.getElementById('hud').style.display = 'flex';
    document.getElementById('game-controls').style.display = 'flex';
    document.getElementById('lvl-tag').innerText = `Ø§Ù„ØµÙØ­Ø© ${idx+1}`;
    if(audioCtx.state === 'suspended') audioCtx.resume();
    startMusic();
}

const setupBtn = (id, key) => {
    const el = document.getElementById(id);
    el.addEventListener('pointerdown', (e) => { e.preventDefault(); inputs[key] = true; });
    el.addEventListener('pointerup', (e) => { e.preventDefault(); inputs[key] = false; });
};
setupBtn('btn-left', 'left'); setupBtn('btn-right', 'right'); setupBtn('btn-jump', 'jump'); setupBtn('btn-draw', 'draw');

function update() {
    if(!isPlaying) return;
    if(inputs.right) { player.vx = 7.5; player.dir = 1; }
    else if(inputs.left) { player.vx = -7.5; player.dir = -1; }
    else player.vx *= 0.85;

    if(inputs.jump && player.grounded) { 
        player.vy = -18; player.grounded = false; 
        player.stretch = 1.3; player.squash = 0.7;
        playSfx(400, 'square', 0.15, 0.05); 
    }
    player.vy += 0.9; player.x += player.vx; player.y += player.vy;
    player.stretch += (1 - player.stretch) * 0.1;
    player.squash += (1 - player.squash) * 0.1;

    if(inputs.draw && player.ink > 0) {
        if(!currentPath) currentPath = [{x:player.x+20, y:player.y+20}];
        else {
            let last = currentPath[currentPath.length-1];
            if(Math.hypot(player.x+20-last.x, player.y+20-last.y) > 15) {
                currentPath.push({x:player.x+20, y:player.y+20}); player.ink -= 0.6;
                playSfx(150 + Math.random()*100, 'sawtooth', 0.05, 0.02);
            }
        }
    } else if(currentPath) { inkPaths.push(currentPath); currentPath = null; }

    player.grounded = false;
    let platforms = [...stages[currentLvlIdx]];
    inkPaths.forEach(path => {
        for(let i=0; i<path.length-1; i++) platforms.push({x: Math.min(path[i].x, path[i+1].x), y: Math.min(path[i].y, path[i+1].y), w: Math.abs(path[i].x - path[i+1].x)+35, h: 12});
    });

    platforms.forEach(p => {
        if(player.x < p.x + p.w && player.x + player.w > p.x && player.y + player.h > p.y && player.y + player.h < p.y + p.h + player.vy) {
            if(!player.grounded) { player.squash = 1.2; player.stretch = 0.8; }
            player.y = p.y - player.h; player.vy = 0; player.grounded = true;
            if(p.goal) { 
                playSfx(600, 'sine', 0.5, 0.1);
                unlockedLevels = Math.min(10, Math.max(unlockedLevels, currentLvlIdx + 2));
                localStorage.setItem('sketchLvl', unlockedLevels);
                isPlaying = false;
                setTimeout(() => {
                    hideAll();
                    document.getElementById('level-select').classList.remove('hidden');
                    updateLevelGrid();
                }, 600);
            }
        }
    });

    if(player.y > 1500) startLevel(currentLvlIdx);
    player.animTimer++;
    if(Math.random() < 0.02) player.eyeBlink = 5;
    if(player.eyeBlink > 0) player.eyeBlink--;
    cam.x += (player.x - canvas.width/2 - cam.x) * 0.1;
    cam.y += (player.y - canvas.height/2 - cam.y) * 0.1;
}

function draw() {
    canvas.width = window.innerWidth; canvas.height = window.innerHeight;
    if(!isPlaying) return;
    ctx.clearRect(0,0,canvas.width,canvas.height);
    ctx.save(); ctx.translate(-cam.x, -cam.y);
    ctx.strokeStyle = "#1a1a1a"; ctx.lineWidth = 4;
    stages[currentLvlIdx].forEach(p => {
        ctx.strokeRect(p.x, p.y, p.w, p.h);
        if(p.goal) { ctx.font="40px Arial"; ctx.fillText("ğŸ", p.x+p.w/2-20, p.y-15); }
    });
    ctx.strokeStyle = "#1a1a1a"; ctx.lineWidth = 8; ctx.lineCap = "round";
    [...inkPaths, currentPath].forEach(path => {
        if(!path) return; 
        ctx.beginPath(); ctx.moveTo(path[0].x, path[0].y);
        path.forEach(pt => ctx.lineTo(pt.x, pt.y)); ctx.stroke();
    });
    
    // Ø±Ø³Ù… Ø®Ø±Ø¨ÙˆØ´ Ø§Ù„Ù…Ø·ÙˆØ± (Ø£Ø¨ÙŠØ¶ Ø§Ù„Ø¬Ø³Ù…)
    ctx.save();
    ctx.translate(player.x + player.w/2, player.y + player.h);
    ctx.scale(player.squash, player.stretch);
    ctx.fillStyle = "white"; // ØªØºÙŠÙŠØ± Ø§Ù„Ù„ÙˆÙ† Ù„Ù„Ø£Ø¨ÙŠØ¶
    ctx.strokeStyle = "#1a1a1a"; // ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø­ÙˆØ§Ù Ù„ÙƒÙŠ ÙŠØ¸Ù‡Ø± Ø¹Ù„Ù‰ Ø§Ù„ÙˆØ±Ù‚
    ctx.lineWidth = 3;
    ctx.fillRect(-player.w/2, -player.h, player.w, player.h);
    ctx.strokeRect(-player.w/2, -player.h, player.w, player.h);
    
    if(player.eyeBlink === 0) {
        ctx.fillStyle = "#1a1a1a"; // Ø§Ù„Ø¹ÙŠÙˆÙ† Ø³ÙˆØ¯Ø§Ø¡
        let eyeOffset = player.dir * 8;
        ctx.fillRect(eyeOffset - 12, -30, 8, 8);
        ctx.fillRect(eyeOffset + 4, -30, 8, 8);
        ctx.fillStyle = "black";
        ctx.fillRect(eyeOffset - 10 + (inputs.right?2:inputs.left?-2:0), -28, 4, 4);
        ctx.fillRect(eyeOffset + 6 + (inputs.right?2:inputs.left?-2:0), -28, 4, 4);
    } else {
        ctx.strokeStyle = "#1a1a1a"; ctx.lineWidth = 2;
        ctx.beginPath(); ctx.moveTo(-12, -26); ctx.lineTo(-4, -26); ctx.moveTo(4, -26); ctx.lineTo(12, -26); ctx.stroke();
    }
    ctx.strokeStyle = "#1a1a1a"; ctx.lineWidth = 2; ctx.beginPath();
    if(!player.grounded) ctx.arc(player.dir*5, -15, 4, 0, Math.PI*2);
    else if(inputs.draw) { ctx.moveTo(player.dir*5 - 5, -15); ctx.lineTo(player.dir*5 + 5, -15); }
    else ctx.arc(player.dir*5, -18, 5, 0.2, Math.PI-0.2);
    ctx.stroke();
    ctx.restore();
    ctx.restore();
    document.getElementById('ink-fill').style.width = player.ink + "%";
}

function toggleMusic() { musicEnabled = !musicEnabled; document.getElementById('music-btn').innerText = `Ø§Ù„Ù…ÙˆØ³ÙŠÙ‚Ù‰: ${musicEnabled ? 'ON' : 'OFF'}`; }
function resetGame() { localStorage.clear(); location.reload(); }
function loop() { update(); draw(); requestAnimationFrame(loop); }

window.onload = () => {
    let p = 0;
    const iv = setInterval(() => {
        p += 5; document.getElementById('load-progress').style.width = p+"%";
        if(p>=100) { clearInterval(iv); hideAll(); document.getElementById('main-menu').classList.remove('hidden'); loop(); }
    }, 30);
};
</script>
</body>
</html>
